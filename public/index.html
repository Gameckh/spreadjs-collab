<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="spreadjs culture" content="zh-cn" />
    <title>在线 Excel 编辑器 | SpreadJS 在线表格编辑器</title>
    <link
        href="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets/styles/gc.spread.sheets.excel2013white.css"
        rel="stylesheet" type="text/css" />
    <link
        href="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-designer/styles/gc.spread.sheets.designer.min.css"
        rel="stylesheet" type="text/css">
    <link href="./custom.css" rel="stylesheet" type="text/css">
</head>

<body>
    <div id="gc-designer-container" role="application"> </div>
    <script type="text/javascript"
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets/dist/gc.spread.sheets.all.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-charts/dist/gc.spread.sheets.charts.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-shapes/dist/gc.spread.sheets.shapes.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-slicers/dist/gc.spread.sheets.slicers.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-print/dist/gc.spread.sheets.print.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-barcode/dist/gc.spread.sheets.barcode.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-pdf/dist/gc.spread.sheets.pdf.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-formula-panel/dist/gc.spread.sheets.formulapanel.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-excelio/dist/gc.spread.excelio.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-io/dist/gc.spread.sheets.io.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-resources-zh/dist/gc.spread.sheets.resources.zh.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-designer-resources-cn/dist/gc.spread.sheets.designer.resource.cn.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/16.2.6/spread-sheets-designer/dist/gc.spread.sheets.designer.all.min.js"></script>

    <script type="module">
        import WebSocketClient from './websocketClient.js';
        import CommandExecutor from './commandExecutor.js';
        import coworkConfig from './toolbarConfig.js';
        window.onload = function () {
            var designer = new GC.Spread.Sheets.Designer.Designer("gc-designer-container");
            // var toolbarConfig = GC.Spread.Sheets.Designer.ToolBarModeConfig;
            designer.setConfig(coworkConfig);
            var spread = designer.getWorkbook();

            // ---------- 设置workbook -----------
            // 禁用新增 sheet 表单
            spread.options.newTabVisible = false;
            // 禁用 sheet 重命名及重置顺序（协同不支持，暂时禁用，等用户提）
            spread.options.tabEditable = false;
            spread.options.allowSheetReorder = false;
            // 右键菜单
            const oldOpenMenu = spread.contextMenu.onOpenMenu;
            spread.contextMenu.onOpenMenu = function (menuData, itemsDataForShown, hitInfo, spread) {
                // 禁用 sheet 页签的右键菜单
                if(hitInfo.tabStripHitInfo) {
                    return;
                }
                const selections = spread.getActiveSheet().getSelections();
                // 禁用 corner 右键菜单
                if (selections[0].row === -1 && selections[0].col === -1) {
                    return;
                }
                oldOpenMenu.apply(this, [menuData, itemsDataForShown, hitInfo, spread]);
            }
            // -----------------------------------

            var commandManager = spread.commandManager();
            const commandExecutor = new CommandExecutor(spread);

            fetch("http://localhost:3000/spreadjs/getCommands")
                .then((res) => {
                    res.json().then((cmds) => {
                        //console.log(cmds);
                        //commandExecutor.fromCommands(cmds);
                    });
                })
                .catch((error) => {
                    console.error("Error:", error);
                });

            // ------------------------------

            const wsClient = new WebSocketClient('ws://localhost:3000');
            wsClient.onMessage((event) => {
                if (event.data instanceof Blob) {
                    // Convert Blob to text
                    const reader = new FileReader();
                    reader.onload = function () {
                        const text = reader.result;
                        console.log("Received text:", text);
                        executeCmd(text);
                    };
                    reader.readAsText(event.data);
                } else {
                    executeCmd(event.data);
                }
            });

            const popUpCommands = ['richText', 'link', 'customSort', 'defineName'];
            function executeCmd(text) {
                console.log("Received text:", text);
                let cmd = JSON.parse(text);
                cmd.outer = true;
                // 当执行填充命令时，需要处理 range 对象
                if (cmd.cmd === "fill") {
                    cmd.startRange = new GC.Spread.Sheets.Range(
                        cmd.startRange.row,
                        cmd.startRange.col,
                        cmd.startRange.rowCount,
                        cmd.startRange.colCount
                    );
                    cmd.fillRange = new GC.Spread.Sheets.Range(
                        cmd.fillRange.row,
                        cmd.fillRange.col,
                        cmd.fillRange.rowCount,
                        cmd.fillRange.colCount
                    );
                }
                // 当遇到所有“弹窗”命令时，阻塞命令执行
                commandManager.execute(cmd);
            }

            // ------------------------------

            commandManager.addListener("anyscLicenser", function () {
                for (var i = 0; i < arguments.length; i++) {
                    var cmd = arguments[i].command;
                    if (cmd.outer) {
                        continue;
                    }
                    if (cmd.clipboardText) {
                        cmd.fromSheet = null;
                        cmd.fromRanges = null;
                    }
                    console.log(JSON.stringify(cmd));
                    wsClient.sendMessage(JSON.stringify(cmd));
                }
            });

        }
    </script>
</body>

</html>